---
title: "КР3 // Обобщенные линейные модели"
subtitle: "Современные методы анализа данных // РАНХиГС"
format: html
editor: source
theme: materia
---

```{r opts, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(include = FALSE)
```

Максимальное количество баллов --- 20 (+2 дополнительных за задание 10.1)

Сегодня мы работаем с [датасетом про ноутбуки](https://raw.githubusercontent.com/angelgardt/da-2023-ranepa/master/data/laptop_price.csv), который содержит следующие переменные:

* `Company` --- компания-производитель компьютера
* `Product` --- бренд и модель
* `TypeName` --- тип ноутбука (Notebook, Ultrabook, Gaming, etc.)
* `Inches` --- размер экрана
* `ScreenResolution` --- разрешение экрана
* `Cpu` --- характеристики процессора
* `Ram` --- размер оперативной памяти
* `Memory` --- память жёсткого диска
* `GPU` --- характеристики графического процессора
* `OpSys` --- операционная система
* `Weight` --- вес компьютера
* `Price_euros` --- цена в Евро


```{r, include=FALSE}
library(tidyverse)
theme_set(theme_bw())
```


## 1

Загрузите [датасет](https://raw.githubusercontent.com/angelgardt/hseuxlab-wlm2021/master/data/laptop_price.csv). Проверьте типы переменных. Если есть такие переменные, которые по своему содержанию должны быть другого типа, приведите их к нужному типу. Сделайте необходимые преобразования с переменными, если они потребуются.

<details>
<summary>*Подсказка*</summary>
Обратите внимание, как записаны переменные `Ram` и `Weight`. Возможно, понадобится функция `str_remove()`.
</details>

```{r}
library(tidyverse)
laptops <- read_csv("https://raw.githubusercontent.com/angelgardt/da-2023-ranepa/master/data/laptop_price.csv")

laptops %>% 
    mutate(Ram = Ram %>% str_remove("GB") %>% as.numeric(),
           Weight = Weight %>% str_remove("kg") %>% as.numeric()) -> laptops
```

## 2

Мы хотим узнать, от каких технических характеристик зависит цена ноутбука. Исследуйте взаимосвязи между ценой и характеристиками ноутбуков. Предположите, какие из характеристик могут быть включены в регрессионную модель в качестве предикторов цены.


## 3

Постройте линейную модель `model1` со случайным интерсептом, которая позволит ответить на вопрос, как зависит цена компьютера от размера экрана? В качестве случайного эффекта включите в модель группировку по компании-производителю.

```{r}
library(lme4)
library(lmerTest)

model1 <- lmer(Price_euros ~ Inches + (1|Company), laptops)
```




## 4

Проверьте статистическую значимость модели `model1` в целом и статистистическую значимость фиксированных предикторов. Проинтерпретируйте полученные результаты.

<details>
<summary>*Пояснение*</summary>
Обычно нас интересует прежде всего интересует фиксированная часть модели, поэтому сосредоточтесь на ней.
</details>

```{r}
model0 <- lmer(Price_euros ~ 1 + (1|Company), laptops)
anova(model0, model1, test = "Chi")
summary(model1)
```




## 5

Включите в модель в качестве *количественного* фиксированного предиктора размер оперативной памяти ноутбука (`Ram`) --- создайте новую модель `model2`.

```{r}
laptops$Ram %>% unique()
model2 <- lmer(Price_euros ~ Inches + Ram + (1|Company), laptops)
```


## 6

Сравните две имеющиеся модели --- с одним (`model1`) и двумя (`model2`) фиксированными предикторами. Проинтерпретируйте результаты.

```{r}
anova(model1, model2, test = "Chi")
```


## 7

Протестируйте статистическую значимость предикторов модели с двумя фиксированными предикторами (`model2`). Проинтерпретируйте результаты. Сравните с результатами тестирования значимости предикторов модели с одним фиксированным предиктором. 

Почему так могло произойти?

```{r}
summary(model2)
```


## 8

Усложните случайную часть модели. Возьмите за основу имеющуюся модель с двумя фиксированными предикторами и добавьте ещё один случайный интерсепт. Группирующую переменную выберите самостоятельно. Обоснуйте выбор случайного фактора. Создайте модель `model3`.

Протестируйте статистическую значимость фиксированных предикторов. Проинтерпретируйте результаты. Если есть что-либо необычное в результатах тестирования, дайте комментарий, почему это могло произойти.

```{r}
laptops$TypeName %>% unique()
model3 <- lmer(Price_euros ~ Inches + Ram + (1|Company) + (1|TypeName), laptops)
summary(model3)
```

## 9

Сравните модели с двумя фиксированными предикторами друг с другом (`model2` и `model3`). Проинтерпретируйте результаты.

<details>
<summary>*Подсказка*</summary>
Обратите внимание на способ подбора модели.
</details>

```{r}
anova(model2, model3, test = "Chi", refit = FALSE)
```

## 10

Проведите дагностику модели `model3`. Достаточно будет графической диагностики: гистограммы распределения остатков модели и диагностического графика зависимости остатков модели от предсказанных значений. Сделайте заключение о качестве модели на основе результатов диагностики.

```{r}
hist(residuals(model3))
plot(fitted.values(model3), residuals(model3))
```



## 10.1

Постройте модель обычной линейной регрессии с такой же структурой предикторов, как в `model3`. Сравните предсказательную силу модели обычной линейной регрессии и модели с одним случайным интерсептом. Какая модель даёт более точные предсказания?

<details>
<summary>*Пояснение*</summary>
Достаточно сравнить суммы квадратов ошибок двух моделей.
</details>

```{r}
model3lm <- lm(Price_euros ~ Inches + Ram, laptops)
sum((laptops$Price_euros - fitted.values(model3))^2)
sum((laptops$Price_euros - fitted.values(model3lm))^2)
```


## Критерии оценки

- **Задание 1 (max 2)**
    - 2 балла --- данные корректно загружены, исследованы типы переменных, произведены преобразования пременных (при необходимости)
    - 1 балл --- данные корректно загружены, исследованы типы переменных, преобразования пременных не произведены (при необходимости)
    - 0 баллов --- данные загружены некорректно
- **Задание 2 (max 2)**
    - 2 балла --- исследованы связи между переменными графическим или аналитическим способом, выдвинуты обоснованные предположения о возможных предикторах цены ноутбука
    - 1 балл --- исследованы связи между переменными графическим или аналитическим способом, предположения о возможных предикторах цены ноутбука не видвинуты
    - 0 баллов --- связи между переменными датасета на исследованы
- **Задание 3 (max 2)**
    - 2 балла --- построена линейная модель, верно заданы фиксированная и случайная части модели
    - 1 балл --- построена линейная модель, однако в структуре модели присутствуют ошибки в задании фиксированной и/или случайной частей
    - 0 баллов --- линейная модель не построена
- **Задание 4 (max 2)**
    - 2 балла --- корректно протестирована статистическая значимость модели в целом и статистическая значимость отдельных предикторов, представлена корректная интерпретация статистических результатов
    - 1 балл --- корректно протестирована статистическая значимость модели в целом и статистическая значимость отдельных предикторов, представлена интерпретация статистических результатов содержит ошибки ИЛИ проведено некорректное тестирование статистической значимости модели в целом и/или статистической значимости отдельных предикторов, представлена корректная интерпретация результатов 
    - 0 баллов --- проведено некорректное тестирование статистической значимости модели в целом и/или статистической значимости отдельных предикторов, представленная интерпретация результатов модержит ошибки ИЛИ тестирование статистической значимости модели и отдельных предикторов не проведено
- **Задание 5 (max 2)**
    - 2 балла --- в модель корректно введен новый предиктор
    - 1 балл --- в модель введен новый предиктор, однако способ введения предиктора в модель не соответствует оказанному в задании
    - 0 баллов --- модель не создана
- **Задание 6 (max 2)**
    - 2 балла --- проведено корректное сравнение двух моделей, представлена корректная интерпретация результатов
    - 1 балл --- проведено сравнение двух моделей и представлена интерпретация результатов, однако сравнение ИЛИ интерпретация содержат ошибки
    - 0 баллов --- проведено сравнение двух моделей и представлена интерпретация результатов, однако сравнение И интерпретация содержат ошибки, ИЛИ сравнение двух моделей не проведено
- **Задание 7 (max 2)**
    - 2 балла --- корректно протестирована статистическая значимость предикторов модели, представлена корректная интерпретация и соспоставление с результатами тестирования другой модели
    - 1 балл --- протестирована статистическая значимость предикторов модели, представлена интерпретация и соспоставление с результатами тестирования другой модели, но в тестировании, интерпретации или сопославлении содержатся ошибки
    - 0 баллов --- тестирование статистической значимости предикторов не проведено
- **Задание 8 (max 2)**
    - 2 балла --- структура созданной модели соответствует заданию, представлено обоснование выбора случайного фактора, корректно проведено тестирование статистической значимости предкиторов и представлена корректная интерпретация результатов
    - 1 балл --- структура созданной модели не соответствует заданию ИЛИ не представлено обоснование выбора случайного фактора ИЛИ некорректно проведено тестирование статистической значимости предкиторов ИЛИ представлена некорректная интерпретация результатов
    - 0 баллов --- модель не создана
- **Задание 9 (max 2)**
    - 2 балла --- проведено корректное сравнение моделей с учетом поставленной задачи и структуры моделей, представлена корректная интерпретация результатов
    - 1 балл --- проведено сравнение моделей без учета поставленной задачи и структуры моделей ИЛИ представленная интерпретация результатов содержит ошибки
    - 0 баллов --- проведено сравнение моделей без учета поставленной задачи и структуры моделей И представленная интерпретация результатов содержит ошибки, ИЛИ сравнение моделей не проведено
- **Задание 10 (max 2)**
    - 2 балла --- проведена диагностика модели, представлено корректное заключение о качестве модели на основе результатов диагностики
    - 1 балл --- проведена диагностика модели, заключение о качестве модели на основе результатов диагностики содержит ошибки
    - 0 баллов --- диагностика не проведена 
- **Задание 10.1 (max 2)**
    - 2 балла --- корректно построена модель обычной линейной регрессии, верно рассчитана метрика качества предсказаний двух моделей, сделан корректный вывод о предсказаельной силе моделей в сравнении их друг с другом
    - 0 баллов --- некорретно построена модель обычной линейной регрессии И/ИЛИ неверное рассчитана метрика качества предскаазкний модели И/ИЛИ сделан неверный вывод о предсказательной силе моделей в сравнении их друг с другом
