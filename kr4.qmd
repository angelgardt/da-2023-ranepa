---
title: "КР4 // Факторный анализ. Кластерный анализ"
subtitle: "Современные методы анализа данных // РАНХиГС"
format: html
editor: source
theme: materia
---

```{r opts, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(include = FALSE)
```

Максимальное количество баллов --- 20 (+2 дополнительных за задание 10.1)

Сегодня мы работаем с [датасетом по Большой пятёрке](https://media.githubusercontent.com/media/angelgardt/da-2023-ranepa/master/data/big_five_bffm.csv).

На измерение каждого фактора в опроснике отведено по десять утверждений:

* `EXT1`--`EXT10` --- extraversion
* `EST1`--`EST10` --- neuroticism (emotional stability)
* `AGR1`--`AGR10` --- agreeableness
* `CSN1`--`CSN10` --- conscientiousness
* `OPN1`--`OPN10` --- openness

С этими переменными мы и будем работать.

Подробное описание датасета представлено [в этом файле](https://raw.githubusercontent.com/angelgardt/da-2023-ranepa/master/data/big_five_bffm_codebook.txt). Факторную структуру опросника можно изучить [здесь](https://ipip.ori.org/newBigFive5broadKey.htm).


```{r}
# bf <- read_tsv("https://media.githubusercontent.com/media/angelgardt/da-2023-ranepa/master/data/big_five_bffm.csv")
# 
# set.seed(824)
# bf %>% 
#     slice(sample(1:nrow(bf), 30086)) %>% 
#     write_tsv("data/bffm.csv")
```

::: {.callout-important}

Датасет содержит 1 015 342 наблюдения.

Это почти 400 Мб данных. Это много. Если ваша машина не справляется с таким объемом, отберите случайную подвыборку из 10 000 / 100 000 / 300 000 наблюдений (в зависимости от мощности машины), и выполняйте задания на ней.

:::

```{r, include=FALSE}
# library(tidyverse)
# theme_set(theme_bw())
```


## 1

Загрузите [датасет](https://media.githubusercontent.com/media/angelgardt/da-2023-ranepa/master/data/big_five_bffm.csv). Проверьте типы переменных. Если есть такие переменные, которые по своему содержанию должны быть другого типа, приведите их к нужному типу. Сделайте необходимые преобразования с переменными, если они потребуются. Если в данных есть пропущенные значения, удалите их из данных.

<details>
<summary>*Подсказка*</summary>
При загрузке файла обратите внимание на разделитель колонок.
</details>

```{r, include=FALSE}
# library(tidyverse)
# bf <- read_tsv("https://media.githubusercontent.com/media/angelgardt/da-2023-ranepa/master/data/big_five_bffm.csv")
# 
# str(bf)
# 
# bf %>%
#     select(1:50) %>%
#     mutate_all(as.numeric) %>%
#     drop_na() -> bigfive
# rm(bf)
# 
# bigfive %>%
#     mutate(id = 1:nrow(bigfive)) -> bigfive
# 
# nrow(bigfive)
```

## 2

Проведите разведочный анализ данных. Выясните, какие есть взаимосвязи между переменными опросника. Какие особенности есть в данных? Что с этим нужно сделать?

```{r, include=FALSE}
# cor(bigfive %>% select(-id)) %>% ggcorrplot::ggcorrplot()
```

## 3

Если необходимы какие-либо преобразования данных перед проведением конфирматорного факторного анализа, выполните их.

<details>
<summary>*Подсказка*</summary>
[Матрица направлений вопросов](https://raw.githubusercontent.com/angelgardt/da-2023-ranepa/master/data/direction_matrix_bffm.csv)
</details>

```{r}
# dirmat <- read_tsv("https://raw.githubusercontent.com/angelgardt/da-2023-ranepa/master/data/direction_matrix_bffm.csv")
# 
# dirmat %>%
#     pivot_longer(-item_in_scale,
#                  values_to = "direction") %>%
#     unite(item, name, item_in_scale, sep="") %>%
#     full_join(
#         bigfive %>%
#             pivot_longer(cols = -id,
#                          names_to = "item",
#                          values_to = "score"),
#         join_by(item)
#     ) %>%
#     mutate(score = ifelse(direction == -1, 6 - score, score)) %>%
#     select(-direction) %>%
#     pivot_wider(names_from = "item",
#                 values_from = "score") -> bffm
```

```{r}
# cor(bffm %>% select(-id)) %>% ggcorrplot::ggcorrplot()
```



## 4

Постройте модель конфирматорного факторного анализа для проверки классической структуры модели Большая пятерка.

```{r}
# library(lavaan)
# model <- "
# EXT =~ EXT1 + EXT2 + EXT3 + EXT4 + EXT5 + EXT6 + EXT7 + EXT8 + EXT9 + EXT10
# EST =~ EST1 + EST2 + EST3 + EST4 + EST5 + EST6 + EST7 + EST8 + EST9 + EST10
# AGR =~ AGR1 + AGR2 + AGR3 + AGR4 + AGR5 + AGR6 + AGR7 + AGR8 + AGR9 + AGR10
# CSN =~ CSN1 + CSN2 + CSN3 + CSN4 + CSN5 + CSN6 + CSN7 + CSN8 + CSN9+ CSN10
# OPN =~ OPN1 + OPN2 + OPN3 + OPN4 + OPN5 + OPN6 + OPN7 + OPN8 + OPN9 + OPN10
# "
# 
# cfa_model <- cfa(model, bffm)
```




## 5

Оцените качество модели. Хорошо ли данные согласуются с моделью?

```{r}
# fitmeasures(cfa_model, c("chisq", "gfi", "agfi","cfi", "tli", "srmr", "rmsea"))
```


## 6

Проинтерпретируйте результаты конфирматорного факторного анализа. Изучите факторные нагрузки, ковариации и остатки модели.

```{r}
# standardizedsolution(cfa_model)
```


## 7

Виузализируйте получившуюся модель.


## 8

Рассчитайте сумму баллов по шкалам опросника для каждого респондента.

```{r}
bffm %>% 
    pivot_longer(-id,
                 names_to = "item",
                 values_to = "score") %>% 
    mutate(scale = str_sub(item, 1, 3)) %>% 
    summarise(score = sum(score),
              .by = c(id, scale)) %>% 
    pivot_wider(names_from = scale,
                values_from = score) -> bffm_scores
```

## 9

Кластеризуйте респондентов по баллам шкал опросника с помощью иерархической кластеризации.

```{r}
d <- dist(bffm_scores %>% select(-id))
```

## 10

Определите оптимальное количество кластеров в иерархической кластеризации.

```{r}

```



## 10.1

Проведите аналогичную кластеризацию с помощью метода k-средних. Сравните результаты двух кластеризаций друг с другом.

```{r}

```


## Критерии оценки

- **Задание 1 (max 2)**
    - 2 балла --- данные корректно загружены, исследованы типы переменных, произведены преобразования пременных (при необходимости)
    - 1 балл --- данные корректно загружены, исследованы типы переменных, преобразования пременных не произведены (при необходимости)
    - 0 баллов --- данные загружены некорректно
- **Задание 2 (max 2)**
    - 2 балла --- исследованы связи между переменными графическим или аналитическим способом, выдвинуты обоснованные предположения о возможных предикторах цены ноутбука
    - 1 балл --- исследованы связи между переменными графическим или аналитическим способом, предположения о возможных предикторах цены ноутбука не видвинуты
    - 0 баллов --- связи между переменными датасета на исследованы
- **Задание 3 (max 2)**
    - 2 балла --- построена линейная модель, верно заданы фиксированная и случайная части модели
    - 1 балл --- построена линейная модель, однако в структуре модели присутствуют ошибки в задании фиксированной и/или случайной частей
    - 0 баллов --- линейная модель не построена
- **Задание 4 (max 2)**
    - 2 балла --- корректно протестирована статистическая значимость модели в целом и статистическая значимость отдельных предикторов, представлена корректная интерпретация статистических результатов
    - 1 балл --- корректно протестирована статистическая значимость модели в целом и статистическая значимость отдельных предикторов, представлена интерпретация статистических результатов содержит ошибки ИЛИ проведено некорректное тестирование статистической значимости модели в целом и/или статистической значимости отдельных предикторов, представлена корректная интерпретация результатов 
    - 0 баллов --- проведено некорректное тестирование статистической значимости модели в целом и/или статистической значимости отдельных предикторов, представленная интерпретация результатов модержит ошибки ИЛИ тестирование статистической значимости модели и отдельных предикторов не проведено
- **Задание 5 (max 2)**
    - 2 балла --- в модель корректно введен новый предиктор
    - 1 балл --- в модель введен новый предиктор, однако способ введения предиктора в модель не соответствует оказанному в задании
    - 0 баллов --- модель не создана
- **Задание 6 (max 2)**
    - 2 балла --- проведено корректное сравнение двух моделей, представлена корректная интерпретация результатов
    - 1 балл --- проведено сравнение двух моделей и представлена интерпретация результатов, однако сравнение ИЛИ интерпретация содержат ошибки
    - 0 баллов --- проведено сравнение двух моделей и представлена интерпретация результатов, однако сравнение И интерпретация содержат ошибки, ИЛИ сравнение двух моделей не проведено
- **Задание 7 (max 2)**
    - 2 балла --- корректно протестирована статистическая значимость предикторов модели, представлена корректная интерпретация и соспоставление с результатами тестирования другой модели
    - 1 балл --- протестирована статистическая значимость предикторов модели, представлена интерпретация и соспоставление с результатами тестирования другой модели, но в тестировании, интерпретации или сопославлении содержатся ошибки
    - 0 баллов --- тестирование статистической значимости предикторов не проведено
- **Задание 8 (max 2)**
    - 2 балла --- структура созданной модели соответствует заданию, представлено обоснование выбора случайного фактора, корректно проведено тестирование статистической значимости предкиторов и представлена корректная интерпретация результатов
    - 1 балл --- структура созданной модели не соответствует заданию ИЛИ не представлено обоснование выбора случайного фактора ИЛИ некорректно проведено тестирование статистической значимости предкиторов ИЛИ представлена некорректная интерпретация результатов
    - 0 баллов --- модель не создана
- **Задание 9 (max 2)**
    - 2 балла --- проведено корректное сравнение моделей с учетом поставленной задачи и структуры моделей, представлена корректная интерпретация результатов
    - 1 балл --- проведено сравнение моделей без учета поставленной задачи и структуры моделей ИЛИ представленная интерпретация результатов содержит ошибки
    - 0 баллов --- проведено сравнение моделей без учета поставленной задачи и структуры моделей И представленная интерпретация результатов содержит ошибки, ИЛИ сравнение моделей не проведено
- **Задание 10 (max 2)**
    - 2 балла --- проведена диагностика модели, представлено корректное заключение о качестве модели на основе результатов диагностики
    - 1 балл --- проведена диагностика модели, заключение о качестве модели на основе результатов диагностики содержит ошибки
    - 0 баллов --- диагностика не проведена 
- **Задание 10.1 (max 2)**
    - 2 балла --- корректно построена модель обычной линейной регрессии, верно рассчитана метрика качества предсказаний двух моделей, сделан корректный вывод о предсказаельной силе моделей в сравнении их друг с другом
    - 0 баллов --- некорретно построена модель обычной линейной регрессии И/ИЛИ неверное рассчитана метрика качества предскаазкний модели И/ИЛИ сделан неверный вывод о предсказательной силе моделей в сравнении их друг с другом
