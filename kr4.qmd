---
title: "КР4 // Факторный анализ. Кластерный анализ"
subtitle: "Современные методы анализа данных // РАНХиГС"
format: html
editor: source
theme: materia
---

```{r opts, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(include = FALSE, eval = FALSE)
```

Максимальное количество баллов --- 20 (+2 дополнительных за задание 10.1)

Сегодня мы работаем с [датасетом по Большой пятёрке](https://raw.githubusercontent.com/angelgardt/da-2023-ranepa/master/data/bffm.csv).

На измерение каждого фактора в опроснике отведено по десять утверждений:

* `EXT1`--`EXT10` --- extraversion
* `EST1`--`EST10` --- neuroticism (emotional stability)
* `AGR1`--`AGR10` --- agreeableness
* `CSN1`--`CSN10` --- conscientiousness
* `OPN1`--`OPN10` --- openness

С этими переменными мы и будем работать.

Подробное описание датасета представлено [в этом файле](https://raw.githubusercontent.com/angelgardt/da-2023-ranepa/master/data/big_five_bffm_codebook.txt). Факторную структуру опросника можно изучить [здесь](https://ipip.ori.org/newBigFive5broadKey.htm).

Датасет содержит 30086 наблюдений.

```{r}
# bf <- read_tsv("https://media.githubusercontent.com/media/angelgardt/da-2023-ranepa/master/data/big_five_bffm.csv")
# 
# set.seed(824)
# bf %>% 
#     slice(sample(1:nrow(bf), 30086)) %>% 
#     write_tsv("data/bffm.csv")
```


```{r, include=FALSE}
library(tidyverse)
theme_set(theme_bw())
```


## 1

Загрузите [датасет](https://raw.githubusercontent.com/angelgardt/da-2023-ranepa/master/data/bffm.csv). Проверьте типы переменных. Если есть такие переменные, которые по своему содержанию должны быть другого типа, приведите их к нужному типу. Сделайте необходимые преобразования с переменными, если они потребуются. Если в данных есть пропущенные значения, удалите их из данных.

<details>
<summary>*Подсказка*</summary>
При загрузке файла обратите внимание на разделитель колонок.
</details>

```{r, include=FALSE}
library(tidyverse)
bf <- read_tsv("https://raw.githubusercontent.com/angelgardt/da-2023-ranepa/master/data/bffm.csv")

nrow(bf)

str(bf)

bf %>%
    select(1:50) %>%
    mutate_all(as.numeric) %>%
    drop_na() -> bigfive
rm(bf)

bigfive %>%
    mutate(id = 1:nrow(bigfive)) -> bigfive

nrow(bigfive)
```

## 2

Проведите разведочный анализ данных. Выясните, какие есть взаимосвязи между переменными опросника. Какие особенности есть в данных?

```{r, include=FALSE}
cor(bigfive %>% select(-id)) %>% ggcorrplot::ggcorrplot()
```

## 3

Если необходимы какие-либо преобразования данных перед проведением конфирматорного факторного анализа, выполните их.

<details>
<summary>*Подсказка*</summary>
[Матрица направлений вопросов](https://raw.githubusercontent.com/angelgardt/da-2023-ranepa/master/data/direction_matrix_bffm.csv)
</details>

```{r}
dirmat <- read_tsv("https://raw.githubusercontent.com/angelgardt/da-2023-ranepa/master/data/direction_matrix_bffm.csv")

dirmat %>%
    pivot_longer(-item_in_scale,
                 values_to = "direction") %>%
    unite(item, name, item_in_scale, sep="") %>%
    full_join(
        bigfive %>%
            pivot_longer(cols = -id,
                         names_to = "item",
                         values_to = "score"),
        join_by(item)
    ) %>%
    mutate(score = ifelse(direction == -1, 6 - score, score)) %>%
    select(-direction) %>%
    pivot_wider(names_from = "item",
                values_from = "score") -> bffm
rm(bigfive)
```

```{r}
cor(bffm %>% select(-id)) %>% ggcorrplot::ggcorrplot()
```



## 4

Постройте модель конфирматорного факторного анализа для проверки классической структуры модели Большая пятерка.

```{r}
library(lavaan)
model <- "
EXT =~ EXT1 + EXT2 + EXT3 + EXT4 + EXT5 + EXT6 + EXT7 + EXT8 + EXT9 + EXT10
EST =~ EST1 + EST2 + EST3 + EST4 + EST5 + EST6 + EST7 + EST8 + EST9 + EST10
AGR =~ AGR1 + AGR2 + AGR3 + AGR4 + AGR5 + AGR6 + AGR7 + AGR8 + AGR9 + AGR10
CSN =~ CSN1 + CSN2 + CSN3 + CSN4 + CSN5 + CSN6 + CSN7 + CSN8 + CSN9+ CSN10
OPN =~ OPN1 + OPN2 + OPN3 + OPN4 + OPN5 + OPN6 + OPN7 + OPN8 + OPN9 + OPN10
"

cfa_model <- cfa(model, bffm)
```




## 5

Оцените качество модели. Хорошо ли данные согласуются с моделью?

```{r}
fitmeasures(cfa_model, c("chisq", "gfi", "agfi","cfi", "tli", "srmr", "rmsea"))
```


## 6

Проинтерпретируйте результаты конфирматорного факторного анализа. Изучите факторные нагрузки, ковариации и остатки модели.

```{r}
standardizedsolution(cfa_model)
```


## 7

Виузализируйте получившуюся модель.


## 8

Отберите 100 случайных респондентов с помощью следующего кода:

```{r, echo=TRUE, eval=FALSE}
set.seed(842)
data %>%  ## подставьте вместо data название датафрейма, с которым вы работаете
    slice(sample(1:nrow(data), 100)) -> data_short # здесь data_short можете заменить на удобное вам название
```

Рассчитайте сумму баллов по шкалам опросника для каждого респондента.

```{r}
set.seed(842)
bffm %>% 
    slice(sample(1:nrow(bffm), 100)) -> bffm_short

bffm_short %>% 
    pivot_longer(-id,
                 names_to = "item",
                 values_to = "score") %>% 
    mutate(scale = str_sub(item, 1, 3)) %>% 
    summarise(score = sum(score),
              .by = c(id, scale)) %>% 
    pivot_wider(names_from = scale,
                values_from = score) -> bffm_scores
```

## 9

Кластеризуйте респондентов по баллам шкал опросника с помощью иерархической кластеризации.

```{r}
d <- dist(bffm_scores %>% select(-id))
hc_complete <- hclust(d, method = "complete")
hc_average <- hclust(d, method = "average")

plot(hc_complete)
plot(hc_average)
```

## 10

Определите оптимальное количество кластеров в иерархической кластеризации.


## 10.1

Проведите аналогичную кластеризацию с помощью метода k-средних. Сравните результаты двух кластеризаций друг с другом.



## Критерии оценки

- **Задание 1 (max 2)**
    - 2 балла --- данные корректно загружены, исследованы типы переменных, произведены преобразования переменных (при необходимости)
    - 1 балл --- данные корректно загружены, исследованы типы переменных, преобразования пременных не произведены (при необходимости)
    - 0 баллов --- данные загружены некорректно
- **Задание 2 (max 3)**
    - 3 балла --- проведен разведочный анализ, исследованы связи между переменными графическим или аналитическим способом, высказано корректное предположение о возможных причинах особенностей данных (при наличии)
    - 2 балла --- проведен разведочный анализ, исследованы связи между переменными графическим или аналитическим способом, высказано предположение о возможных причинах особенностей данных (при наличии)
    - 1 балл --- исследованы связи между переменными графическим или аналитическим способом, предположение о возможных причинах особенностей данных не высказано (при наличии)
    - 0 баллов --- связи между переменными датасета на исследованы
- **Задание 3 (max 3)**
    - 3 балла --- данные приведены к виду, необходимому для проведения КФА, преобразования выполнены оптимальным [с точки зрения кода] образом
    - 2 балла --- данные приведены к виду, необходимому для проведения КФА, преобразования выполнены неоптимальным [с точки зрения кода] образом
    - 1 балл --- данные частично приведены к виду, необходимому для проведения КФА
    - 0 баллов --- данные не приведены к требуемому виду
- **Задание 4 (max 2)**
    - 2 балла --- модель КФА корректно задана, выполнено создание объекта модели
    - 1 балл --- модель КФА задана частично корректно, выполнено создание объекта модели
    - 0 баллов --- модель КФА задана некорректно И/ИЛИ не выполнено создание объекта модели
- **Задание 5 (max 2)**
    - 2 балла --- проведена оценка качества модели КФА, дана полная и корректная интерпретация результатов
    - 1 балл --- проведена оценка качества модели КФА, интерпретация результатов корректная, но неполная
    - 0 баллов --- оценка качества модели не проведена ИЛИ интерпретация результатов некорректная
- **Задание 6 (max 2)**
    - 2 балла --- дана полная и корректная интерпретация результатов моделирования
    - 1 балл --- дана корректная, но неполная интерпретация результатов моделирования
    - 0 баллов --- интерпретация результатов отсутствует И/ИЛИ не корректна
- **Задание 7 (max 1)**
    - 1 балл --- построена визуализация модели КФА
    - 0 баллов --- визуализация модели КФА отсутствует
- **Задание 8 (max 1)**
    - 1 балла --- отобрана случайная часть выборки, корректно рассчитан суммарный балл по шкалам опросника
    - 0 балл --- отобрана случайная часть выборки, суммарный балл по шкалам опросника не рассчитан ИЛИ рассчитан некорректно
- **Задание 9 (max 2)**
    - 2 балла --- кластеризация выполнена корректно, рассмотрены несколько способов иерархической кластеризации
    - 1 балл --- кластеризация выполнена корректно, рассмотрен один способ иерархической кластеризации
    - 0 баллов --- кластеризация не выполнена ИЛИ выполнена некорректно
- **Задание 10 (max 2)**
    - 2 балла --- определено оптимальное число кластеров для иерархического кластерного анализа, представлено обоснование выбранного числа кластеров
    - 1 балл --- определено число кластеров, однако обоснование выбора отсутствует
    - 0 баллов --- число кластеров не выбрано
- **Задание 10.1 (max 2)**
    - 2 балла --- корректно выполнена кластеризация методом k-средних, результаты кластеризации методом k-средних сопоставлены с результатами иерархической кластеризации
    - 0 баллов --- кластеризация методом k-средних выполнена некорректно И/ИЛИ отсутствует сопоставление результатов двух кластеризаций
